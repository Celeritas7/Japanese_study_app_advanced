CREATE TABLE japanese_user_reviews (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL,
  kanji TEXT NOT NULL,
  test_type TEXT NOT NULL,        -- 'kanji_write', 'reading', 'meaning'
  current_rating INTEGER DEFAULT 5,
  last_test_date DATE,
  last_result BOOLEAN,            -- true=correct, false=wrong
  next_review_date DATE DEFAULT CURRENT_DATE,
  streak INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, kanji, test_type)
);

-- Index for fast "due today" queries
CREATE INDEX idx_reviews_user_due ON japanese_user_reviews(user_id, next_review_date);
CREATE INDEX idx_reviews_user_kanji ON japanese_user_reviews(user_id, kanji);

-- RLS Policy
ALTER TABLE japanese_user_reviews ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own reviews" ON japanese_user_reviews
  FOR ALL USING (auth.uid()::text = user_id);


xxxxxxxxxxxxxxxxxxxxxxxxxxxx


ALTER VIEW v_vocabulary_full RENAME TO japanese_v_vocabulary_full;
ALTER VIEW v_level_summary RENAME TO japanese_v_level_summary;
ALTER VIEW v_words_per_day RENAME TO japanese_v_words_per_day;


xxxxxxxxxxxxxxxxxx

CREATE TABLE japanese_daily_test_log (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL,
  kanji TEXT NOT NULL,
  test_type TEXT NOT NULL,        -- 'kanji_write', 'reading', 'meaning'
  result BOOLEAN NOT NULL,        -- true=correct, false=wrong
  test_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index for fast "today's mistakes" query
CREATE INDEX idx_daily_log_user_date ON japanese_daily_test_log(user_id, test_date);

-- RLS Policy
ALTER TABLE japanese_daily_test_log ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own logs" ON japanese_daily_test_log
  FOR ALL USING (auth.uid()::text = user_id);

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx



CREATE TABLE japanese_kanji_story_groups (
  id SERIAL PRIMARY KEY,
  group_number INTEGER,
  group_kanji TEXT NOT NULL,
  group_meaning TEXT,
  group_story TEXT,
  onyomi TEXT,
  kunyomi TEXT,
  UNIQUE(group_kanji)
);

-- Public read access
ALTER TABLE japanese_kanji_story_groups ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read" ON japanese_kanji_story_groups FOR SELECT USING (true);


-- 1. Delete the existing member table to start fresh
DROP TABLE IF EXISTS japanese_kanji_stories CASCADE;

-- 2. Create the table with your preferred column order
CREATE TABLE japanese_kanji_stories (
  id SERIAL PRIMARY KEY,
  group_id INTEGER REFERENCES japanese_kanji_story_groups(id), -- Links to your Group table
  member_number INTEGER,      -- Position in group (1, 2, 3...)
  kanji TEXT NOT NULL,        -- The character
  original_kanji TEXT,        -- Your reference column (now in the middle!)
  meaning TEXT,
  story TEXT,
  onyomi TEXT,
  kunyomi TEXT,               -- Added to match your Group table structure
  frame_number TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(kanji)               -- Ensures no duplicate kanji entries
);

-- 3. Enable Security (matching your Group table settings)
ALTER TABLE japanese_kanji_stories ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read" ON japanese_kanji_stories FOR SELECT USING (true);

-- 4. Speed index
CREATE INDEX idx_kanji_lookup ON japanese_kanji_stories(kanji);


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


CREATE TABLE japanese_kanji_stories (
  id SERIAL PRIMARY KEY,
  group_kanji TEXT NOT NULL,      -- Links to parent group
  member_number INTEGER,
  kanji TEXT NOT NULL,
  meaning TEXT,
  story TEXT,
  frame_number TEXT,
  onyomi TEXT,
  kunyomi TEXT,
  UNIQUE(kanji)
);

-- Index for lookups
CREATE INDEX idx_stories_group ON japanese_kanji_stories(group_kanji);
CREATE INDEX idx_stories_kanji ON japanese_kanji_stories(kanji);

-- Public read access
ALTER TABLE japanese_kanji_stories ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read" ON japanese_kanji_stories FOR SELECT USING (true);


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx



CREATE TABLE japanese_kanji_similar_groups (
  id SERIAL PRIMARY KEY,
  group_type TEXT NOT NULL,       -- 'radical', 'onyomi', 'kunyomi', 'component'
  group_key TEXT NOT NULL,        -- e.g., '月', 'カン', '氵'
  group_name TEXT,                -- Human readable: "にくづき (flesh radical)"
  kanji_list TEXT[] NOT NULL,     -- Array: ['胃', '腸', '肝', '脾']
  kanji_count INTEGER,
  UNIQUE(group_type, group_key)
);

-- Index for lookups
CREATE INDEX idx_similar_type ON japanese_kanji_similar_groups(group_type);
CREATE INDEX idx_similar_key ON japanese_kanji_similar_groups(group_key);

-- Public read access
ALTER TABLE japanese_kanji_similar_groups ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public read" ON japanese_kanji_similar_groups FOR SELECT USING (true);

